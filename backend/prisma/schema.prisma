generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DiscogsArtist {
  id                   String                 @id @default(uuid())
  name                 String                 @unique
  realname             String?
  profile              String?                @db.Text
  dataQuality          String?
  urls                 Json?                  @db.JsonB
  nameVariations       Json?                  @db.JsonB
  aliases              Json?                  @db.JsonB
  members              Json?                  @db.JsonB
  groups               Json?                  @db.JsonB
  lastUpdated          DateTime
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  DiscogsReleaseArtist DiscogsReleaseArtist[]

  @@index([name])
}

model DiscogsDataSync {
  id                String    @id
  dumpDate          String    @unique
  artistsFile       String?
  releasesFile      String?
  artistsProcessed  Int       @default(0)
  releasesProcessed Int       @default(0)
  tracksProcessed   Int       @default(0)
  songsUpserted     Int       @default(0)
  status            String
  startedAt         DateTime
  completedAt       DateTime?
  error             String?

  @@index([status])
}

model DiscogsRelease {
  id                   String                 @id @default(uuid())
  title                String
  status               String
  genres               Json?
  styles               Json?
  released             String?
  dataQuality          String?
  youtubeVideos        Json?
  lastUpdated          DateTime
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  DiscogsReleaseArtist DiscogsReleaseArtist[]
  Song                 Song[]

  @@index([title])
}

model DiscogsReleaseArtist {
  releaseId      String
  artistId       String
  DiscogsArtist  DiscogsArtist  @relation(fields: [artistId], references: [id], onDelete: Cascade)
  DiscogsRelease DiscogsRelease @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  @@id([releaseId, artistId])
}

model HomePageFeed {
  id          String   @id
  genre       String   @unique
  songs       Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  tagline     String?
  sourceType  String?
  playlistUrl String?

  @@index([genre])
}

model MagicToken {
  id        String   @id
  token     String   @unique
  userId    String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  username  String?
  email     String?
  User      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([expiresAt])
  @@index([token])
  @@index([username])
}

model PasswordResetToken {
  id        String   @id
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model Playlist {
  id                String         @id
  name              String
  description       String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime
  userId            String
  sourceUrl         String?
  sourceType        String?
  autoUpdate        Boolean        @default(false)
  lastSyncedAt      DateTime?
  expectedSongCount Int?
  User              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  PlaylistSong      PlaylistSong[]
}

model PlaylistSong {
  id         String   @id
  position   Int      @default(0)
  createdAt  DateTime @default(now())
  playlistId String
  songId     String
  Playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  Song       Song     @relation(fields: [songId], references: [id], onDelete: Cascade)

  @@unique([playlistId, songId])
  @@index([playlistId, position])
}

model Song {
  id                   String         @id @default(uuid())
  title                String
  artist               String?
  youtubeId            String?        @unique
  thumbnailUrl         String?
  duration             Int?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  artistIds            Json?
  discogsCountry       String?
  discogsExtraArtists  Json?
  discogsFormat        String?
  discogsGenres        Json?
  discogsLabel         String?
  discogsLastUpdated   DateTime?
  discogsMasterId      String?
  releaseId            String?
  discogsReleased      String?
  discogsStyles        Json?
  discogsTrackPosition String?
  PlaylistSong         PlaylistSong[]
  DiscogsRelease       DiscogsRelease? @relation(fields: [releaseId], references: [id])

  @@index([artist])
  @@index([releaseId])
  @@index([title])
  @@index([youtubeId])
}

model User {
  id                 String               @id
  username           String?              @unique
  password           String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  email              String?              @unique
  MagicToken         MagicToken[]
  PasswordResetToken PasswordResetToken[]
  Playlist           Playlist[]
}

model session {
  sid    String   @id
  sess   Json
  expire DateTime @db.Timestamp(6)

  @@index([expire])
}
